<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Outbreak Link</title>
  <style>
    :root{
      --ink:#E9FFF2;
      --mut:rgba(233,255,242,.72);
      --line:rgba(255,255,255,.10);
      --g:#45FF75; --b:#2FA9FF; --p:#B16BFF; --y:#FFB94A; --r:#FF4D6D;
      --panel:rgba(6,10,12,.62);
      --shadow:0 22px 90px rgba(0,0,0,.55);
      --r1:22px; --r2:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --ui: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;color:var(--ink);font-family:var(--ui);background:#05070B;overflow:hidden}
    .bg{
      position:fixed; inset:0; z-index:0;
      background:
        radial-gradient(1100px 700px at 50% 22%, rgba(69,255,117,.16), transparent 60%),
        radial-gradient(900px 650px at 82% 22%, rgba(47,169,255,.14), transparent 60%),
        radial-gradient(900px 650px at 35% 80%, rgba(177,107,255,.12), transparent 62%),
        url("bg.jpg") center/cover no-repeat;
      filter:saturate(1.02) contrast(1.06) brightness(.66);
      transform:scale(1.03);
    }
    .overlay{
      position:fixed; inset:0; z-index:1; pointer-events:none;
      background:
        radial-gradient(1200px 800px at 50% 20%, rgba(0,0,0,.00), rgba(0,0,0,.62) 62%),
        linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.62));
    }
    .scan{position:fixed; inset:0; z-index:2; pointer-events:none; opacity:.12; mix-blend-mode:overlay;
      background:repeating-linear-gradient(0deg, rgba(255,255,255,.05) 0, rgba(255,255,255,.05) 1px, transparent 2px, transparent 4px);}
    .wrap{position:relative; z-index:3; height:100%; display:grid; place-items:center; padding:14px}
    .shell{width:min(1100px,100%); display:grid; gap:14px}
    .topbar{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      border:1px solid var(--line); border-radius:var(--r1);
      background:linear-gradient(180deg, rgba(7,12,14,.74), rgba(6,10,12,.44));
      box-shadow:var(--shadow); padding:10px 12px;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .bio{
      width:40px;height:40px;border-radius:14px;
      background:
        radial-gradient(circle at 35% 35%, rgba(255,185,74,.95), rgba(255,185,74,.10) 52%, transparent 62%),
        radial-gradient(circle at 70% 65%, rgba(69,255,117,.30), transparent 60%),
        linear-gradient(180deg, rgba(12,18,18,.95), rgba(6,10,12,.95));
      border:1px solid rgba(255,185,74,.30);
      position:relative; overflow:hidden;
    }
    .bio::after{content:"‚ò£"; position:absolute; inset:0; display:grid; place-items:center;
      font-family:var(--mono); font-weight:1000; opacity:.22; transform:rotate(-12deg)}
    .title{margin:0; font-family:var(--mono); font-weight:1000; letter-spacing:.08em; text-transform:uppercase}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10); background:rgba(6,10,12,.45); font-family:var(--mono); font-size:12px;}
    .dot{width:8px;height:8px;border-radius:50%}
    .dg{background:var(--g); box-shadow:0 0 14px rgba(69,255,117,.45)}
    .db{background:var(--b); box-shadow:0 0 14px rgba(47,169,255,.35)}
    .dy{background:var(--y); box-shadow:0 0 14px rgba(255,185,74,.25)}
    select{
      background:rgba(6,10,12,.55); color:var(--ink);
      border:1px solid rgba(255,255,255,.14); border-radius:12px;
      padding:8px 10px; font-family:var(--mono); letter-spacing:.04em;
    }

    .stage{
      display:grid; grid-template-columns: 360px 1fr 360px; gap:14px;
    }
    @media (max-width: 1050px){ .stage{grid-template-columns:1fr} }
    .panel{
      border:1px solid var(--line); border-radius:var(--r1);
      background:var(--panel); backdrop-filter:blur(10px);
      box-shadow:var(--shadow); overflow:hidden; position:relative;
    }
    .ph{padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.10);
      display:flex; justify-content:space-between; align-items:center; gap:10px}
    .ph b{font-family:var(--mono); letter-spacing:.12em; text-transform:uppercase; font-weight:1000; font-size:12px}
    .pb{padding:14px; position:relative}

    .btn{
      width:100%; border:0; cursor:pointer; user-select:none;
      padding:14px; border-radius:14px;
      font-family:var(--mono); letter-spacing:.10em; text-transform:uppercase; font-weight:1000; font-size:12px;
      color:rgba(233,255,242,.96);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 14px 40px rgba(0,0,0,.35);
      transition:transform .08s ease, filter .15s ease;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      position:relative; overflow:hidden; text-align:left;
    }
    .btn:hover{filter:brightness(1.10)}
    .btn:active{transform:translateY(1px)}
    .btn:disabled{opacity:.45; cursor:not-allowed}
    .btn small{opacity:.75; letter-spacing:.06em}
    .btn::after{
      content:""; position:absolute; inset:-40% -20%;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
      transform:rotate(12deg) translateX(-40%); opacity:.55;
    }
    .btn:hover::after{transform:rotate(12deg) translateX(20%); transition:transform .5s ease}
    .green{background:linear-gradient(180deg, rgba(69,255,117,.30), rgba(69,255,117,.10)); border-color:rgba(69,255,117,.34)}
    .blue{background:linear-gradient(180deg, rgba(47,169,255,.26), rgba(47,169,255,.08)); border-color:rgba(47,169,255,.30)}
    .purple{background:linear-gradient(180deg, rgba(177,107,255,.26), rgba(177,107,255,.08)); border-color:rgba(177,107,255,.30)}
    .yellow{background:linear-gradient(180deg, rgba(255,185,74,.24), rgba(255,185,74,.08)); border-color:rgba(255,185,74,.30)}
    .red{background:linear-gradient(180deg, rgba(255,77,109,.20), rgba(255,77,109,.07)); border-color:rgba(255,77,109,.26)}

    .stat{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px; border-radius:14px; border:1px solid rgba(255,255,255,.10);
      background:rgba(8,12,14,.48); font-family:var(--mono); font-size:12px; letter-spacing:.06em; text-transform:uppercase;
      margin-bottom:10px;
    }
    .glowG{color:var(--g); text-shadow:0 0 18px rgba(69,255,117,.22)}
    .glowB{color:var(--b); text-shadow:0 0 18px rgba(47,169,255,.18)}
    .desc{color:var(--mut); line-height:1.6; font-size:14px; margin:10px 0 0}
    .card{
      border:1px solid rgba(255,255,255,.10); border-radius:var(--r2);
      background:rgba(8,12,14,.52); overflow:hidden; position:relative;
    }
    .cardIn{padding:14px; display:grid; grid-template-columns: 140px 1fr; gap:12px; align-items:center}
    @media (max-width: 520px){ .cardIn{grid-template-columns:1fr} }
    .avatar{
      width:140px;height:140px;border-radius:20px; border:1px solid rgba(69,255,117,.20);
      background:
        radial-gradient(circle at 35% 30%, rgba(69,255,117,.55), transparent 55%),
        radial-gradient(circle at 70% 65%, rgba(47,169,255,.25), transparent 60%),
        linear-gradient(180deg, rgba(12,18,18,.95), rgba(6,10,12,.95));
      box-shadow:0 0 0 1px rgba(255,255,255,.06) inset, 0 18px 60px rgba(0,0,0,.55);
      position:relative; overflow:hidden;
    }
    .avatar span{position:absolute; inset:0; display:grid; place-items:center; font-family:var(--mono); font-weight:1000; letter-spacing:.10em; opacity:.9}
    .kv{margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; font-family:var(--mono); font-size:12px}
    .k{padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.10); background:rgba(6,10,12,.40)}
    .k b{color:var(--g)}

    .screen{display:none}
    .screen.show{display:block}

    /* GAME */
    #gameWrap{display:grid; gap:10px}
    canvas{width:100%; height:420px; border-radius:16px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.25)}
    .hudRow{display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; align-items:center}
    .hudRow .pill{font-size:12px}
    .joy{
      position:absolute; left:18px; bottom:18px; width:140px; height:140px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12); background:rgba(6,10,12,.35); display:none;
    }
    .joy i{
      position:absolute; left:50%; top:50%; width:52px; height:52px; border-radius:999px;
      transform:translate(-50%,-50%);
      border:1px solid rgba(255,255,255,.14);
      background:rgba(69,255,117,.14);
      box-shadow:0 0 20px rgba(69,255,117,.15);
    }
    .gameBox{position:relative}
    @media (hover:none) and (pointer:coarse){
      .joy{display:block}
      canvas{height:520px}
    }

    .toast{
      position:fixed; left:50%; bottom:14px; transform:translateX(-50%);
      z-index:10; background:rgba(7,10,12,.86);
      border:1px solid rgba(255,255,255,.14); border-radius:14px;
      padding:12px 14px; box-shadow:var(--shadow);
      font-family:var(--mono); font-size:12px; display:none;
      max-width:min(760px, calc(100vw - 24px));
    }
    .toast.show{display:block}

    /* RTL support */
    [dir="rtl"] .brand{flex-direction:row-reverse}
    [dir="rtl"] .btn{flex-direction:row-reverse; text-align:right}
    [dir="rtl"] .cardIn{direction:rtl}
    [dir="rtl"] .ph{direction:rtl}
  </style>
</head>
<body>
  <div class="bg"></div><div class="overlay"></div><div class="scan"></div>

  <div class="wrap">
    <div class="shell">
      <div class="topbar">
        <div class="brand">
          <div class="bio"></div>
          <h1 class="title">OUTBREAK LINK</h1>
          <div class="pill"><span class="dot dg"></span><span id="creatorTag">CREATOR</span></div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <div class="pill"><span class="dot db"></span><span id="refHint">ref: ‚Äî</span></div>
          <div class="pill"><span class="dot dy"></span>ID: <b id="hudId">‚Äî</b></div>
          <select id="lang"></select>
        </div>
      </div>

      <div class="stage">

        <!-- LEFT -->
        <aside class="panel">
          <div class="ph"><b data-i18n="menu">MENU</b><span class="pill"><span class="dot dg"></span><span data-i18n="online">ONLINE</span></span></div>
          <div class="pb" style="display:grid;gap:10px">
            <button class="btn purple" id="btnIntro"><span data-i18n="btn_story">STORY</span><small data-i18n="btn_story_s">origin</small></button>
            <button class="btn green" id="btnClaim"><span data-i18n="btn_getid">GET INFECTION ID</span><small data-i18n="btn_getid_s">issue number</small></button>
            <button class="btn blue" id="btnPlay" disabled><span data-i18n="btn_play">PLAY RUN</span><small data-i18n="btn_play_s">45 sec</small></button>
            <button class="btn yellow" id="btnWorld"><span data-i18n="btn_world">WORLD OUTBREAK</span><small data-i18n="btn_world_s">countries</small></button>
            <button class="btn red" id="btnReset"><span data-i18n="btn_reset">RESET</span><small data-i18n="btn_reset_s">local demo</small></button>

            <a class="btn blue" href="https://t.me/ZombieVirusLabBot" target="_blank" rel="noreferrer">
              <span data-i18n="btn_bot">OPEN BOT</span><small>@ZombieVirusLabBot</small>
            </a>
            <a class="btn blue" href="https://t.me/zombievirus_server" target="_blank" rel="noreferrer">
              <span data-i18n="btn_server">OPEN SERVER</span><small>@zombievirus_server</small>
            </a>
          </div>
        </aside>

        <!-- CENTER -->
        <main class="panel">
          <div class="ph"><b id="centerTitle">LOBBY</b><span class="pill"><span class="dot dy"></span>v0.1</span></div>
          <div class="pb">

            <!-- STORY -->
            <div class="screen show" id="scrIntro">
              <div class="card">
                <div class="cardIn">
                  <div class="avatar"><span>‚ò£</span></div>
                  <div>
                    <h2 style="margin:0;font-family:var(--mono);letter-spacing:.08em;text-transform:uppercase" data-i18n="story_t">THE LAB</h2>
                    <p class="desc" id="storyText"></p>
                    <div style="margin-top:12px;display:grid;gap:10px">
                      <button class="btn green" id="btnStoryNext"><span data-i18n="btn_continue">CONTINUE</span><small data-i18n="btn_continue_s">next</small></button>
                      <button class="btn blue" id="btnSkip"><span data-i18n="btn_skip">SKIP</span><small data-i18n="btn_skip_s">to lobby</small></button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- LOBBY -->
            <div class="screen" id="scrLobby">
              <div class="card">
                <div class="cardIn">
                  <div class="avatar"><span id="bigId">#000000</span></div>
                  <div>
                    <h2 style="margin:0;font-family:var(--mono);letter-spacing:.08em;text-transform:uppercase" data-i18n="cert_t">INFECTION CERTIFICATE</h2>
                    <p class="desc" data-i18n="cert_d">
                      Get an ID ‚Üí share your link ‚Üí infect friends ‚Üí climb the world outbreak.
                    </p>
                    <div class="kv">
                      <div class="k">ID: <b id="meId">‚Äî</b></div>
                      <div class="k"><span data-i18n="by">BY</span>: <b id="meBy">‚Äî</b></div>
                      <div class="k"><span data-i18n="inf">INF</span>: <b id="meInf">0</b></div>
                      <div class="k"><span data-i18n="country">COUNTRY</span>: <b id="meCountry">‚Äî</b></div>
                    </div>
                    <div style="margin-top:12px;display:grid;gap:10px">
                      <button class="btn blue" id="btnCopy" disabled><span data-i18n="btn_copy">COPY LINK</span><small data-i18n="btn_copy_s">clipboard</small></button>
                      <button class="btn yellow" id="btnCard" disabled><span data-i18n="btn_card">DOWNLOAD CARD</span><small data-i18n="btn_card_s">png</small></button>
                    </div>
                  </div>
                </div>
              </div>
              <p class="desc" style="margin-top:12px" data-i18n="lobby_hint">
                Tip: the most viral thing is your share card. Post it and infect someone.
              </p>
            </div>

            <!-- GAME -->
            <div class="screen" id="scrGame">
              <div id="gameWrap">
                <div class="hudRow">
                  <div class="pill"><span class="dot dg"></span><span data-i18n="time">TIME</span>: <b id="tLeft">45</b></div>
                  <div class="pill"><span class="dot db"></span><span data-i18n="score">SCORE</span>: <b id="score">0</b></div>
                  <div class="pill"><span class="dot dy"></span><span data-i18n="rank">RANK</span>: <b id="rank">ROOKIE</b></div>
                </div>
                <div class="gameBox">
                  <canvas id="cv" width="1100" height="520"></canvas>
                  <div class="joy" id="joy"><i id="joyKnob"></i></div>
                </div>
                <button class="btn red" id="btnQuit"><span data-i18n="btn_quit">QUIT</span><small data-i18n="btn_quit_s">to lobby</small></button>
              </div>
            </div>

            <!-- RESULT -->
            <div class="screen" id="scrResult">
              <div class="card">
                <div class="cardIn">
                  <div class="avatar"><span>‚òÖ</span></div>
                  <div>
                    <h2 style="margin:0;font-family:var(--mono);letter-spacing:.08em;text-transform:uppercase" data-i18n="res_t">RUN COMPLETE</h2>
                    <p class="desc"><span data-i18n="res_score">Your score</span>: <b id="resScore" class="glowG">0</b></p>
                    <p class="desc"><span data-i18n="res_mut">Mutation found</span>: <b id="resMut" class="glowB">‚Äî</b></p>
                    <div style="margin-top:12px;display:grid;gap:10px">
                      <button class="btn green" id="btnReplay"><span data-i18n="btn_replay">REPLAY</span><small data-i18n="btn_replay_s">again</small></button>
                      <button class="btn blue" id="btnCopy2"><span data-i18n="btn_copy">COPY LINK</span><small data-i18n="btn_copy_s">clipboard</small></button>
                      <button class="btn yellow" id="btnCard2"><span data-i18n="btn_card">DOWNLOAD CARD</span><small data-i18n="btn_card_s">png</small></button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- WORLD (demo) -->
            <div class="screen" id="scrWorld">
              <div class="card">
                <div class="cardIn">
                  <div class="avatar"><span>üåç</span></div>
                  <div>
                    <h2 style="margin:0;font-family:var(--mono);letter-spacing:.08em;text-transform:uppercase" data-i18n="world_t">WORLD OUTBREAK</h2>
                    <p class="desc" data-i18n="world_d">
                      In v0.1 country is selected manually. In global version the timeline will show countries infected in order.
                    </p>
                    <button class="btn blue" id="btnBack"><span data-i18n="btn_back">BACK</span><small data-i18n="btn_back_s">to lobby</small></button>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </main>

        <!-- RIGHT -->
        <aside class="panel">
          <div class="ph"><b data-i18n="status">STATUS</b><span class="pill"><span class="dot dg"></span><span data-i18n="online">ONLINE</span></span></div>
          <div class="pb">
            <div class="stat"><span>ID</span><b class="glowG" id="pId">‚Äî</b></div>
            <div class="stat"><span data-i18n="by">BY</span><b class="glowB" id="pBy">‚Äî</b></div>
            <div class="stat"><span data-i18n="inf">INF</span><b class="glowG" id="pInf">0</b></div>
            <div class="stat"><span data-i18n="country">COUNTRY</span><b id="pCountry">‚Äî</b></div>
            <p class="desc" data-i18n="core">
              Core: the virus spreads only through the link. Your job is to infect others.
            </p>
          </div>
        </aside>

      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ===== i18n =====
    const I18N = {
      en: {
        menu:"MENU", online:"ONLINE", status:"STATUS",
        btn_story:"STORY", btn_story_s:"origin",
        btn_getid:"GET INFECTION ID", btn_getid_s:"issue number",
        btn_play:"PLAY RUN", btn_play_s:"45 sec",
        btn_world:"WORLD OUTBREAK", btn_world_s:"countries",
        btn_reset:"RESET", btn_reset_s:"local demo",
        btn_bot:"OPEN BOT", btn_server:"OPEN SERVER",
        btn_continue:"CONTINUE", btn_continue_s:"next",
        btn_skip:"SKIP", btn_skip_s:"to lobby",
        cert_t:"INFECTION CERTIFICATE",
        cert_d:"Get an ID ‚Üí share your link ‚Üí infect friends ‚Üí climb the world outbreak.",
        lobby_hint:"Tip: the most viral thing is your share card. Post it and infect someone.",
        btn_copy:"COPY LINK", btn_copy_s:"clipboard",
        btn_card:"DOWNLOAD CARD", btn_card_s:"png",
        btn_quit:"QUIT", btn_quit_s:"to lobby",
        time:"TIME", score:"SCORE", rank:"RANK",
        res_t:"RUN COMPLETE", res_score:"Your score", res_mut:"Mutation found",
        btn_replay:"REPLAY", btn_replay_s:"again",
        world_t:"WORLD OUTBREAK",
        world_d:"In v0.1 country is selected manually. In global version the timeline will show countries infected in order.",
        btn_back:"BACK", btn_back_s:"to lobby",
        by:"BY", inf:"INF", country:"COUNTRY",
        core:"Core: the virus spreads only through the link. Your job is to infect others.",
        story_t:"THE LAB",
        story_1:"You are the CREATOR. In a silent lab you mix glowing reagents. On the monitor: PROJECT ZG-01 ‚Äî OUTBREAK LINK.",
        story_2:"Warning flashes: SAFE MODE OFF. You press SYNTHESIZE.",
        story_3:"This virus doesn‚Äôt infect bodies. It infects a LINK.",
        story_4:"Anyone who opens the link becomes infected and receives a number. To survive, they spread it further."
      },
      ru: {
        menu:"–ú–ï–ù–Æ", online:"–û–ù–õ–ê–ô–ù", status:"–°–¢–ê–¢–£–°",
        btn_story:"–ò–°–¢–û–†–ò–Ø", btn_story_s:"–ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–µ",
        btn_getid:"–ü–û–õ–£–ß–ò–¢–¨ ID", btn_getid_s:"–Ω–æ–º–µ—Ä –∑–∞—Ä–∞–∂–µ–Ω–∏—è",
        btn_play:"–ò–ì–†–ê–¢–¨ –†–ê–ù", btn_play_s:"45 —Å–µ–∫",
        btn_world:"–ú–ò–†–û–í–û–ô –í–ò–†–£–°", btn_world_s:"—Å—Ç—Ä–∞–Ω—ã",
        btn_reset:"–°–ë–†–û–°", btn_reset_s:"–ª–æ–∫–∞–ª—å–Ω–æ",
        btn_bot:"–û–¢–ö–†–´–¢–¨ –ë–û–¢–ê", btn_server:"–û–¢–ö–†–´–¢–¨ –°–ï–†–í–ï–†",
        btn_continue:"–î–ê–õ–ï–ï", btn_continue_s:"—Å–ª–µ–¥—É—é—â–µ–µ",
        btn_skip:"–ü–†–û–ü–£–°–¢–ò–¢–¨", btn_skip_s:"–≤ –ª–æ–±–±–∏",
        cert_t:"–°–ï–†–¢–ò–§–ò–ö–ê–¢ –ó–ê–†–ê–ñ–ï–ù–ò–Ø",
        cert_d:"–ü–æ–ª—É—á–∏ ID ‚Üí –ø–æ–¥–µ–ª–∏—Å—å —Å—Å—ã–ª–∫–æ–π ‚Üí –∑–∞—Ä–∞–∑–∏ –¥—Ä—É–∑–µ–π ‚Üí –ø–æ–¥–Ω–∏–º–∞–π—Å—è –≤ –º–∏—Ä–æ–≤–æ–º –≤–∏—Ä—É—Å–µ.",
        lobby_hint:"–ü–æ–¥—Å–∫–∞–∑–∫–∞: —Å–∞–º–æ–µ –≤–∏—Ä—É—Å–Ω–æ–µ ‚Äî —Ç–≤–æ—è –∫–∞—Ä—Ç–æ—á–∫–∞. –ö–∏–Ω—å –µ—ë –∏ –∑–∞—Ä–∞–∑–∏ –∫–æ–≥–æ-—Ç–æ.",
        btn_copy:"–°–ö–û–ü–ò–†–û–í–ê–¢–¨ –°–°–´–õ–ö–£", btn_copy_s:"–±—É—Ñ–µ—Ä",
        btn_card:"–°–ö–ê–ß–ê–¢–¨ –ö–ê–†–¢–û–ß–ö–£", btn_card_s:"png",
        btn_quit:"–í–´–ô–¢–ò", btn_quit_s:"–≤ –ª–æ–±–±–∏",
        time:"–í–†–ï–ú–Ø", score:"–°–ß–Å–¢", rank:"–†–ê–ù–ì",
        res_t:"–†–ê–ù –ó–ê–í–ï–†–®–Å–ù", res_score:"–¢–≤–æ–π —Å—á—ë—Ç", res_mut:"–ù–∞–π–¥–µ–Ω–∞ –º—É—Ç–∞—Ü–∏—è",
        btn_replay:"–ï–©–Å –†–ê–ó", btn_replay_s:"—Å–Ω–æ–≤–∞",
        world_t:"–ú–ò–†–û–í–û–ï –ó–ê–†–ê–ñ–ï–ù–ò–ï",
        world_d:"–í v0.1 —Å—Ç—Ä–∞–Ω–∞ –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é. –í –≥–ª–æ–±–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Ä—è–¥–æ–∫ –∑–∞—Ä–∞–∂–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω –ø–æ –≤—Ä–µ–º–µ–Ω–∏.",
        btn_back:"–ù–ê–ó–ê–î", btn_back_s:"–≤ –ª–æ–±–±–∏",
        by:"–û–¢", inf:"–ó–ê–†–ê–ó–ò–õ", country:"–°–¢–†–ê–ù–ê",
        core:"–Ø–¥—Ä–æ: –≤–∏—Ä—É—Å —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Å—Å—ã–ª–∫—É. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∑–∞—Ä–∞–∂–∞—Ç—å –¥–∞–ª—å—à–µ.",
        story_t:"–õ–ê–ë–û–†–ê–¢–û–†–ò–Ø",
        story_1:"–¢—ã ‚Äî –°–û–ó–î–ê–¢–ï–õ–¨. –í —Ç—ë–º–Ω–æ–π –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏ —Ç—ã —Å–º–µ—à–∏–≤–∞–µ—à—å —Å–≤–µ—Ç—è—â–∏–µ—Å—è —Ä–µ–∞–≥–µ–Ω—Ç—ã. –ù–∞ –º–æ–Ω–∏—Ç–æ—Ä–µ: PROJECT ZG-01 ‚Äî OUTBREAK LINK.",
        story_2:"–ú–∏–≥–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: SAFE MODE OFF. –¢—ã –Ω–∞–∂–∏–º–∞–µ—à—å SYNTHESIZE.",
        story_3:"–≠—Ç–æ—Ç –≤–∏—Ä—É—Å –∑–∞—Ä–∞–∂–∞–µ—Ç –Ω–µ —Ç–µ–ª–æ. –û–Ω –∑–∞—Ä–∞–∂–∞–µ—Ç –°–°–´–õ–ö–£.",
        story_4:"–õ—é–±–æ–π, –∫—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Å—Å—ã–ª–∫—É, —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∑–∞—Ä–∞–∂—ë–Ω–Ω—ã–º –∏ –ø–æ–ª—É—á–∞–µ—Ç –Ω–æ–º–µ—Ä. –ß—Ç–æ–±—ã –≤–∏—Ä—É—Å –∂–∏–ª ‚Äî –æ–Ω —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—è–µ—Ç—Å—è –¥–∞–ª—å—à–µ."
      },
      es:{ menu:"MEN√ö", online:"EN L√çNEA", status:"ESTADO",
        btn_story:"HISTORIA",btn_story_s:"origen",btn_getid:"OBTENER ID",btn_getid_s:"n√∫mero",
        btn_play:"JUGAR",btn_play_s:"45 s",btn_world:"BROTE MUNDIAL",btn_world_s:"pa√≠ses",
        btn_reset:"REINICIAR",btn_reset_s:"local",btn_bot:"ABRIR BOT",btn_server:"ABRIR SERVIDOR",
        btn_continue:"CONTINUAR",btn_continue_s:"siguiente",btn_skip:"SALTAR",btn_skip_s:"al lobby",
        cert_t:"CERTIFICADO",cert_d:"Consigue ID ‚Üí comparte enlace ‚Üí infecta ‚Üí sube en el brote.",
        lobby_hint:"Consejo: lo m√°s viral es tu tarjeta. Publ√≠cala e infecta a alguien.",
        btn_copy:"COPIAR ENLACE",btn_copy_s:"portapapeles",btn_card:"DESCARGAR TARJETA",btn_card_s:"png",
        btn_quit:"SALIR",btn_quit_s:"al lobby",time:"TIEMPO",score:"PUNTOS",rank:"RANGO",
        res_t:"PARTIDA LISTA",res_score:"Tu puntuaci√≥n",res_mut:"Mutaci√≥n",
        btn_replay:"REPETIR",btn_replay_s:"otra",world_t:"BROTE MUNDIAL",
        world_d:"En v0.1 eliges pa√≠s manualmente. En global habr√° l√≠nea temporal por pa√≠ses.",
        btn_back:"ATR√ÅS",btn_back_s:"al lobby",by:"POR",inf:"INF",country:"PA√çS",
        core:"N√∫cleo: el virus se propaga solo por el enlace. Tu misi√≥n es infectar.",
        story_t:"LAB",story_1:"Eres el CREADOR. Mezclas reactivos. Proyecto ZG-01 ‚Äî OUTBREAK LINK.",
        story_2:"SAFE MODE OFF. Pulsas SYNTHESIZE.",story_3:"Este virus infecta un ENLACE.",story_4:"Abren el link ‚Üí reciben n√∫mero ‚Üí lo propagan."},
      pt:{ menu:"MENU", online:"ONLINE", status:"STATUS",
        btn_story:"HIST√ìRIA",btn_story_s:"origem",btn_getid:"PEGAR ID",btn_getid_s:"n√∫mero",
        btn_play:"JOGAR",btn_play_s:"45 s",btn_world:"SURTO MUNDIAL",btn_world_s:"pa√≠ses",
        btn_reset:"RESET",btn_reset_s:"local",btn_bot:"ABRIR BOT",btn_server:"ABRIR SERVIDOR",
        btn_continue:"CONTINUAR",btn_continue_s:"pr√≥ximo",btn_skip:"PULAR",btn_skip_s:"lobby",
        cert_t:"CERTIFICADO",cert_d:"Pegue ID ‚Üí compartilhe link ‚Üí infecte ‚Üí suba no surto.",
        lobby_hint:"Dica: o mais viral √© seu card. Poste e infecte algu√©m.",
        btn_copy:"COPIAR LINK",btn_copy_s:"clipboard",btn_card:"BAIXAR CARD",btn_card_s:"png",
        btn_quit:"SAIR",btn_quit_s:"lobby",time:"TEMPO",score:"SCORE",rank:"RANK",
        res_t:"RUN FINALIZADA",res_score:"Seu score",res_mut:"Muta√ß√£o",
        btn_replay:"DE NOVO",btn_replay_s:"again",world_t:"SURTO MUNDIAL",
        world_d:"v0.1: pa√≠s manual. Global: timeline por pa√≠ses.",
        btn_back:"VOLTAR",btn_back_s:"lobby",by:"POR",inf:"INF",country:"PA√çS",
        core:"N√∫cleo: o v√≠rus espalha s√≥ pelo link. Sua miss√£o √© infectar.",
        story_t:"LAB",story_1:"Voc√™ √© o CRIADOR. Projeto ZG-01 ‚Äî OUTBREAK LINK.",
        story_2:"SAFE MODE OFF. SYNTHESIZE.",story_3:"V√≠rus infecta um LINK.",story_4:"Abre link ‚Üí n√∫mero ‚Üí propaga."},
      fr:{ menu:"MENU", online:"EN LIGNE", status:"STATUT",
        btn_story:"HISTOIRE",btn_story_s:"origine",btn_getid:"OBTENIR ID",btn_getid_s:"num√©ro",
        btn_play:"JOUER",btn_play_s:"45 s",btn_world:"√âPID√âMIE MONDIALE",btn_world_s:"pays",
        btn_reset:"R√âINITIALISER",btn_reset_s:"local",btn_bot:"OUVRIR BOT",btn_server:"OUVRIR SERVEUR",
        btn_continue:"CONTINUER",btn_continue_s:"suivant",btn_skip:"PASSER",btn_skip_s:"lobby",
        cert_t:"CERTIFICAT",cert_d:"Obtiens un ID ‚Üí partage le lien ‚Üí infecte ‚Üí monte.",
        lobby_hint:"Astuce: le plus viral = ta carte. Poste-la et infecte.",
        btn_copy:"COPIER LIEN",btn_copy_s:"presse-papiers",btn_card:"T√âL√âCHARGER CARTE",btn_card_s:"png",
        btn_quit:"QUITTER",btn_quit_s:"lobby",time:"TEMPS",score:"SCORE",rank:"RANG",
        res_t:"RUN TERMIN√â",res_score:"Ton score",res_mut:"Mutation",
        btn_replay:"REJOUER",btn_replay_s:"encore",world_t:"√âPID√âMIE MONDIALE",
        world_d:"v0.1: pays manuel. Global: timeline des pays infect√©s.",
        btn_back:"RETOUR",btn_back_s:"lobby",by:"PAR",inf:"INF",country:"PAYS",
        core:"Noyau: le virus se propage via le lien. Ta mission: infecter.",
        story_t:"LABO",story_1:"Tu es le CR√âATEUR. Projet ZG-01 ‚Äî OUTBREAK LINK.",
        story_2:"SAFE MODE OFF. SYNTHESIZE.",story_3:"Le virus infecte un LIEN.",story_4:"Ouvre le lien ‚Üí num√©ro ‚Üí propage."},
      de:{ menu:"MEN√ú", online:"ONLINE", status:"STATUS",
        btn_story:"STORY",btn_story_s:"ursprung",btn_getid:"ID HOLEN",btn_getid_s:"nummer",
        btn_play:"SPIELEN",btn_play_s:"45 s",btn_world:"WELT-AUSBRUCH",btn_world_s:"l√§nder",
        btn_reset:"RESET",btn_reset_s:"lokal",btn_bot:"BOT √ñFFNEN",btn_server:"SERVER √ñFFNEN",
        btn_continue:"WEITER",btn_continue_s:"n√§chstes",btn_skip:"√úBERSPRINGEN",btn_skip_s:"lobby",
        cert_t:"ZERTIFIKAT",cert_d:"ID holen ‚Üí Link teilen ‚Üí infizieren ‚Üí aufsteigen.",
        lobby_hint:"Tipp: am viralsten ist deine Karte. Poste sie und infiziere.",
        btn_copy:"LINK KOPIEREN",btn_copy_s:"clipboard",btn_card:"KARTE LADEN",btn_card_s:"png",
        btn_quit:"BEENDEN",btn_quit_s:"lobby",time:"ZEIT",score:"SCORE",rank:"RANG",
        res_t:"RUN FERTIG",res_score:"Dein Score",res_mut:"Mutation",
        btn_replay:"NOCHMAL",btn_replay_s:"again",world_t:"WELT-AUSBRUCH",
        world_d:"v0.1: Land manuell. Global: Timeline nach L√§ndern.",
        btn_back:"ZUR√úCK",btn_back_s:"lobby",by:"VON",inf:"INF",country:"LAND",
        core:"Kern: Virus verbreitet sich nur √ºber den Link. Mission: infizieren.",
        story_t:"LABOR",story_1:"Du bist der CREATOR. Projekt ZG-01 ‚Äî OUTBREAK LINK.",
        story_2:"SAFE MODE OFF. SYNTHESIZE.",story_3:"Virus infiziert einen LINK.",story_4:"Link √∂ffnen ‚Üí Nummer ‚Üí weitergeben."},
      tr:{ menu:"MEN√ú", online:"√áEVRƒ∞Mƒ∞√áƒ∞", status:"DURUM",
        btn_story:"Hƒ∞KAYE",btn_story_s:"k√∂ken",btn_getid:"ID AL",btn_getid_s:"numara",
        btn_play:"OYNAT",btn_play_s:"45 sn",btn_world:"D√úNYA SALGINI",btn_world_s:"√ºlkeler",
        btn_reset:"SIFIRLA",btn_reset_s:"yerel",btn_bot:"BOT A√á",btn_server:"SUNUCU A√á",
        btn_continue:"DEVAM",btn_continue_s:"sonraki",btn_skip:"GE√á",btn_skip_s:"lobi",
        cert_t:"SERTƒ∞Fƒ∞KA",cert_d:"ID al ‚Üí link payla≈ü ‚Üí enfekte et ‚Üí y√ºksel.",
        lobby_hint:"ƒ∞pucu: en viral ≈üey kartƒ±n. Payla≈ü ve enfekte et.",
        btn_copy:"Lƒ∞NK KOPYALA",btn_copy_s:"clipboard",btn_card:"KART ƒ∞NDƒ∞R",btn_card_s:"png",
        btn_quit:"√áIK",btn_quit_s:"lobi",time:"S√úRE",score:"SKOR",rank:"R√úTBE",
        res_t:"Bƒ∞TTƒ∞",res_score:"Skorun",res_mut:"Mutasyon",
        btn_replay:"TEKRAR",btn_replay_s:"again",world_t:"D√úNYA SALGINI",
        world_d:"v0.1: √ºlke manuel. Global: √ºlke zaman √ßizelgesi.",
        btn_back:"GERƒ∞",btn_back_s:"lobi",by:"Kƒ∞MDEN",inf:"INF",country:"√úLKE",
        core:"√áekirdek: vir√ºs sadece link ile yayƒ±lƒ±r. G√∂rev: enfekte et.",
        story_t:"LAB",story_1:"Sen YARATICI'sƒ±n. Proje ZG-01 ‚Äî OUTBREAK LINK.",
        story_2:"SAFE MODE OFF. SYNTHESIZE.",story_3:"Vir√ºs bir Lƒ∞NK'i enfekte eder.",story_4:"Link ‚Üí numara ‚Üí yayƒ±lma."},
      ar:{ menu:"ÿßŸÑŸÇÿßÿ¶ŸÖÿ©", online:"ŸÖÿ™ÿµŸÑ", status:"ÿßŸÑÿ≠ÿßŸÑÿ©",
        btn_story:"ÿßŸÑŸÇÿµÿ©",btn_story_s:"ÿßŸÑÿ£ÿµŸÑ",btn_getid:"ÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ID",btn_getid_s:"ÿ±ŸÇŸÖ",
        btn_play:"ÿßÿ®ÿØÿ£ ÿßŸÑŸÑÿπÿ®",btn_play_s:"45ÿ´",btn_world:"ÿ™ŸÅÿ¥ŸëŸä ÿπÿßŸÑŸÖŸä",btn_world_s:"ÿØŸàŸÑ",
        btn_reset:"ÿ•ÿπÿßÿØÿ©",btn_reset_s:"ŸÖÿ≠ŸÑŸä",btn_bot:"ÿßŸÅÿ™ÿ≠ ÿßŸÑÿ®Ÿàÿ™",btn_server:"ÿßŸÅÿ™ÿ≠ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±",
        btn_continue:"ŸÖÿ™ÿßÿ®ÿπÿ©",btn_continue_s:"ÿßŸÑÿ™ÿßŸÑŸä",btn_skip:"ÿ™ÿÆÿ∑Ÿä",btn_skip_s:"ŸÑŸÑŸàÿßÿ¨Ÿáÿ©",
        cert_t:"ÿ¥ŸáÿßÿØÿ© ÿßŸÑÿπÿØŸàŸâ",cert_d:"ÿÆÿ∞ ID ‚Üí ÿ¥ÿßÿ±ŸÉ ÿßŸÑÿ±ÿßÿ®ÿ∑ ‚Üí ÿπÿØŸê ÿßŸÑÿ¢ÿÆÿ±ŸäŸÜ ‚Üí ÿßÿµÿπÿØ.",
        lobby_hint:"ŸÜÿµŸäÿ≠ÿ©: ÿßŸÑÿ£ŸÉÿ´ÿ± ÿßŸÜÿ™ÿ¥ÿßÿ±Ÿãÿß ŸáŸà ÿ®ÿ∑ÿßŸÇÿ™ŸÉ. ÿßŸÜÿ¥ÿ±Ÿáÿß Ÿàÿ£ÿµŸêÿ® ÿ¥ÿÆÿµŸãÿß.",
        btn_copy:"ÿßŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑",btn_copy_s:"ÿßŸÑÿ≠ÿßŸÅÿ∏ÿ©",btn_card:"ÿ≠ŸÖŸëŸÑ ÿßŸÑÿ®ÿ∑ÿßŸÇÿ©",btn_card_s:"png",
        btn_quit:"ÿÆÿ±Ÿàÿ¨",btn_quit_s:"ŸÑŸÑŸàÿßÿ¨Ÿáÿ©",time:"ÿßŸÑŸàŸÇÿ™",score:"ÿßŸÑŸÜŸÇÿßÿ∑",rank:"ÿßŸÑÿ±ÿ™ÿ®ÿ©",
        res_t:"ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑÿ¨ŸàŸÑÿ©",res_score:"ŸÜÿ™Ÿäÿ¨ÿ™ŸÉ",res_mut:"ÿßŸÑÿ∑ŸÅÿ±ÿ©",
        btn_replay:"ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ",btn_replay_s:"again",world_t:"ÿ™ŸÅÿ¥ŸëŸä ÿπÿßŸÑŸÖŸä",
        world_d:"v0.1: ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿØŸàŸÑÿ© ŸäÿØŸàŸäŸãÿß. ÿπÿßŸÑŸÖŸäŸãÿß: ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿØŸàŸÑ ÿ≠ÿ≥ÿ® ÿßŸÑÿ≤ŸÖŸÜ.",
        btn_back:"ÿ±ÿ¨Ÿàÿπ",btn_back_s:"ŸÑŸÑŸàÿßÿ¨Ÿáÿ©",by:"ÿ®Ÿàÿßÿ≥ÿ∑ÿ©",inf:"ÿπÿØŸàŸâ",country:"ÿßŸÑÿØŸàŸÑÿ©",
        core:"ÿßŸÑÿ£ÿ≥ÿßÿ≥: ÿßŸÑŸÅŸäÿ±Ÿàÿ≥ ŸäŸÜÿ™ÿ¥ÿ± ÿπÿ®ÿ± ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸÅŸÇÿ∑. ŸÖŸáŸÖÿ™ŸÉ: ÿßŸÜÿ¥ÿ±Ÿá.",
        story_t:"ÿßŸÑŸÖÿÆÿ™ÿ®ÿ±",story_1:"ÿ£ŸÜÿ™ ÿßŸÑŸÖŸèŸÜÿ¥ÿ¶. ŸÖÿ¥ÿ±Ÿàÿπ ZG-01 ‚Äî OUTBREAK LINK.",
        story_2:"SAFE MODE OFF. SYNTHESIZE.",story_3:"ÿßŸÑŸÅŸäÿ±Ÿàÿ≥ ŸäÿµŸäÿ® ÿ±ÿßÿ®ÿ∑Ÿãÿß.",story_4:"ŸäŸÅÿ™ÿ≠ ÿßŸÑÿ±ÿßÿ®ÿ∑ ‚Üí ÿ±ŸÇŸÖ ‚Üí ŸäŸÜÿ¥ÿ±Ÿá."}
    };

    const LANGS = [
      ["en","EN"],["ru","RU"],["es","ES"],["pt","PT"],["fr","FR"],["de","DE"],["tr","TR"],["ar","AR"]
    ];

    function pickLang(){
      const saved = localStorage.getItem("ol_lang");
      if(saved && I18N[saved]) return saved;
      const nav = (navigator.language || "en").toLowerCase();
      const base = nav.split("-")[0];
      if(I18N[base]) return base;
      return "en";
    }

    let lang = pickLang();

    function setDir(){
      document.documentElement.lang = lang;
      document.documentElement.dir = (lang === "ar") ? "rtl" : "ltr";
    }

    function t(key){
      return (I18N[lang] && I18N[lang][key]) || (I18N.en[key]) || key;
    }

    function applyI18n(){
      setDir();
      document.querySelectorAll("[data-i18n]").forEach(el=>{
        el.textContent = t(el.getAttribute("data-i18n"));
      });
      storySteps = [t("story_1"),t("story_2"),t("story_3"),t("story_4")];
      storyIdx = 0; renderStory();
    }

    const langSel = document.getElementById("lang");
    LANGS.forEach(([k,label])=>{
      const o = document.createElement("option");
      o.value = k; o.textContent = label;
      langSel.appendChild(o);
    });
    langSel.value = lang;
    langSel.onchange = ()=>{
      lang = langSel.value;
      localStorage.setItem("ol_lang", lang);
      applyI18n();
      render();
    };

    // ===== state (local demo) =====
    const LS = "outbreaklink_v01";
    const $ = (id)=>document.getElementById(id);
    const toastEl = $("toast");
    const fmt = (n)=>"#"+String(n).padStart(6,"0");

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      clearTimeout(toastEl._t);
      toastEl._t = setTimeout(()=>toastEl.classList.remove("show"), 1800);
    }

    function getRef(){
      const u = new URL(location.href);
      const r = u.searchParams.get("ref");
      const num = r ? Number(r) : null;
      return Number.isFinite(num) ? num : null;
    }
    function buildLink(id){
      const u = new URL(location.href);
      u.searchParams.set("ref", String(id));
      u.hash = "";
      return u.toString();
    }

    function load(){ try{ return JSON.parse(localStorage.getItem(LS) || "null"); }catch{ return null; } }
    function save(s){ localStorage.setItem(LS, JSON.stringify(s)); }
    function init(){
      const s = load() || { next:1, me:null, users:{} };
      save(s); return s;
    }

    // ===== screens =====
    function show(screenId, title){
      ["scrIntro","scrLobby","scrGame","scrResult","scrWorld"].forEach(id=>{
        $(id).classList.toggle("show", id===screenId);
      });
      $("centerTitle").textContent = title;
    }

    // ===== story =====
    let storySteps = [];
    let storyIdx = 0;
    function renderStory(){ $("storyText").textContent = storySteps[storyIdx] || ""; }
    $("btnStoryNext").onclick = ()=>{
      storyIdx++;
      if(storyIdx >= storySteps.length){
        show("scrLobby","LOBBY");
      } else renderStory();
    };
    $("btnSkip").onclick = ()=> show("scrLobby","LOBBY");

    // ===== country (manual for v0.1) =====
    const COUNTRY_LIST = ["AT","DE","TR","US","FR","ES","PT","IT","PL","UA","GB","CA","BR","MX","IN","SA","AE","EG","JP","KR"];
    function chooseCountry(){
      const s = init();
      if(!s.me) return null;
      if(s.me.country) return s.me.country;
      // super-simple prompt for v0.1
      const pick = prompt("Choose country code (e.g. AT, DE, TR):\n" + COUNTRY_LIST.join(", "), "AT");
      const cc = (pick || "AT").trim().toUpperCase().slice(0,2);
      s.me.country = cc;
      s.users[String(s.me.id)] = s.me;
      save(s);
      return cc;
    }

    // ===== claim =====
    $("btnClaim").onclick = ()=>{
      const s = init();
      if(s.me){ toast("ALREADY HAS ID"); return; }
      const ref = getRef();
      const id = s.next++;
      const me = { id, by: ref || null, inf: 0, country:null };
      s.me = me;
      s.users[String(id)] = me;

      // demo: if ref exists locally -> +1 infection
      if(ref && s.users[String(ref)]) s.users[String(ref)].inf = (s.users[String(ref)].inf || 0) + 1;

      save(s);
      history.replaceState(null, "", buildLink(id));

      // country selection (v0.1 manual)
      chooseCountry();

      toast("ID ISSUED: " + fmt(id));
      render();
      show("scrLobby","LOBBY");
    };

    // ===== copy link =====
    async function copyLink(){
      const s = init();
      if(!s.me) return;
      const link = buildLink(s.me.id);
      try{ await navigator.clipboard.writeText(link); toast("LINK COPIED"); }
      catch{ toast("COPY FAILED"); }
    }
    $("btnCopy").onclick = copyLink;
    $("btnCopy2").onclick = copyLink;

    // ===== share card =====
    function mutationRoll(){
      const pool = [
        ["Green Pulse","COMMON"],["Night Sprint","COMMON"],["Blood Trail","RARE"],
        ["Shadow Step","RARE"],["Anti-Horde","EPIC"],["Creator‚Äôs Blessing","EPIC"]
      ];
      const r = Math.random();
      if(r < 0.60) return pool[Math.floor(Math.random()*2)];
      if(r < 0.90) return pool[2 + Math.floor(Math.random()*2)];
      return pool[4 + Math.floor(Math.random()*2)];
    }

    function downloadCard(score, mut){
      const s = init(); if(!s.me) return;
      const me = s.me;
      const idTxt = fmt(me.id);
      const byTxt = me.by ? fmt(me.by) : "‚Äî";
      const infTxt = String(me.inf||0);
      const ctry = me.country || "‚Äî";
      const linkTxt = buildLink(me.id);

      const c = document.createElement("canvas");
      c.width = 1200; c.height = 630;
      const ctx = c.getContext("2d");

      // bg
      const grd = ctx.createLinearGradient(0,0,1200,630);
      grd.addColorStop(0, "#06100B");
      grd.addColorStop(0.55, "#061016");
      grd.addColorStop(1, "#0A0710");
      ctx.fillStyle = grd; ctx.fillRect(0,0,1200,630);

      // title
      ctx.fillStyle = "rgba(233,255,242,.95)";
      ctx.font = "900 44px ui-monospace, Menlo, Consolas, monospace";
      ctx.fillText("OUTBREAK LINK", 60, 105);

      // ID big
      ctx.fillStyle = "#45FF75";
      ctx.font = "1000 120px ui-monospace, Menlo, Consolas, monospace";
      ctx.fillText(idTxt, 60, 245);

      // details
      ctx.fillStyle = "rgba(233,255,242,.85)";
      ctx.font = "900 30px ui-monospace, Menlo, Consolas, monospace";
      ctx.fillText("BY: " + byTxt, 60, 315);
      ctx.fillText("COUNTRY: " + ctry, 60, 365);
      ctx.fillText("INFECTIONS: " + infTxt, 60, 415);
      ctx.fillText("SCORE: " + String(score), 60, 465);
      ctx.fillText("MUTATION: " + mut, 60, 515);

      // creator
      ctx.fillStyle = "rgba(233,255,242,.70)";
      ctx.font = "700 22px ui-monospace, Menlo, Consolas, monospace";
      ctx.fillText("Game by CREATOR", 60, 575);

      // link
      ctx.fillStyle = "rgba(233,255,242,.55)";
      ctx.fillText(linkTxt.slice(0, 78) + (linkTxt.length>78?"‚Ä¶":""), 60, 605);

      // hazard
      ctx.globalAlpha = 0.14;
      ctx.fillStyle = "#45FF75";
      ctx.font = "900 320px ui-monospace, Menlo, Consolas, monospace";
      ctx.fillText("‚ò£", 880, 360);
      ctx.globalAlpha = 1;

      const a = document.createElement("a");
      a.href = c.toDataURL("image/png");
      a.download = "outbreaklink-card.png";
      a.click();
      toast("CARD DOWNLOADED");
    }

    $("btnCard").onclick = ()=>{
      const s = init(); if(!s.me) return;
      downloadCard(0, "‚Äî");
    };
    $("btnCard2").onclick = ()=>{
      downloadCard(lastScore, lastMut);
    };

    // ===== navigation buttons =====
    $("btnIntro").onclick = ()=> show("scrIntro","STORY");
    $("btnWorld").onclick = ()=> show("scrWorld","WORLD");
    $("btnBack").onclick = ()=> show("scrLobby","LOBBY");
    $("btnReset").onclick = ()=>{ localStorage.removeItem(LS); toast("RESET"); location.search=""; };

    // ===== game (simple survivor) =====
    const cv = $("cv"), ctx = cv.getContext("2d");
    let running=false, t=45, score=0, lastScore=0, lastMut="‚Äî";
    let keys = {};
    window.addEventListener("keydown", e=> keys[e.key.toLowerCase()]=true);
    window.addEventListener("keyup", e=> keys[e.key.toLowerCase()]=false);

    // joystick
    const joy = $("joy"), knob = $("joyKnob");
    let jx=0, jy=0, joyActive=false, joyCenter={x:0,y:0};
    function joyPos(e){
      const t = (e.touches? e.touches[0] : e);
      const r = joy.getBoundingClientRect();
      return {x: t.clientX - r.left, y: t.clientY - r.top, r};
    }
    function joyStart(e){
      joyActive=true;
      const p = joyPos(e);
      joyCenter = {x: p.r.width/2, y: p.r.height/2};
      joyMove(e);
    }
    function joyMove(e){
      if(!joyActive) return;
      const p = joyPos(e);
      const dx = p.x - joyCenter.x;
      const dy = p.y - joyCenter.y;
      const max = 42;
      const len = Math.hypot(dx,dy) || 1;
      const nx = dx/len, ny = dy/len;
      const mag = Math.min(max, len);
      jx = (nx * mag) / max;
      jy = (ny * mag) / max;
      knob.style.transform = `translate(${dx/len*mag - 26}px, ${dy/len*mag - 26}px)`;
      e.preventDefault?.();
    }
    function joyEnd(){
      joyActive=false; jx=0; jy=0;
      knob.style.transform = "translate(-50%,-50%)";
    }
    joy.addEventListener("pointerdown", joyStart);
    window.addEventListener("pointermove", joyMove, {passive:false});
    window.addEventListener("pointerup", joyEnd);
    joy.addEventListener("touchstart", joyStart, {passive:false});
    window.addEventListener("touchmove", joyMove, {passive:false});
    window.addEventListener("touchend", joyEnd);

    function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }

    let player, zombies, spawnT, pulseT;

    function resetRun(){
      player = {x: cv.width/2, y: cv.height/2, r:14, hp:1};
      zombies = [];
      spawnT = 0;
      pulseT = 0;
      t = 45; score = 0;
      $("tLeft").textContent = t;
      $("score").textContent = score;
      $("rank").textContent = "ROOKIE";
    }

    function spawnZombie(){
      const side = Math.floor(Math.random()*4);
      let x=0,y=0;
      if(side===0){x=Math.random()*cv.width; y=-20;}
      if(side===1){x=cv.width+20; y=Math.random()*cv.height;}
      if(side===2){x=Math.random()*cv.width; y=cv.height+20;}
      if(side===3){x=-20; y=Math.random()*cv.height;}
      zombies.push({x,y,r:12,spd: 80 + Math.random()*60, hp:1});
    }

    function update(dt){
      // timer
      spawnT += dt; pulseT += dt;
      if(spawnT > 0.55){ spawnT = 0; spawnZombie(); }

      t -= dt;
      if(t <= 0){ t = 0; endRun(true); return; }
      $("tLeft").textContent = Math.ceil(t);

      // movement
      let vx=0, vy=0;
      if(keys["w"]||keys["arrowup"]) vy -= 1;
      if(keys["s"]||keys["arrowdown"]) vy += 1;
      if(keys["a"]||keys["arrowleft"]) vx -= 1;
      if(keys["d"]||keys["arrowright"]) vx += 1;

      // joystick overrides (mobile)
      vx += jx; vy += jy;

      const len = Math.hypot(vx,vy) || 1;
      vx /= len; vy /= len;
      const spd = 210;
      player.x = clamp(player.x + vx*spd*dt, 14, cv.width-14);
      player.y = clamp(player.y + vy*spd*dt, 14, cv.height-14);

      // pulse (auto-attack)
      if(pulseT > 0.38){
        pulseT = 0;
        // hit nearest zombie in radius
        let hit = null, best = 999999;
        for(const z of zombies){
          const d = Math.hypot(z.x-player.x, z.y-player.y);
          if(d < 95 && d < best){ best = d; hit = z; }
        }
        if(hit){
          hit.hp -= 1;
          if(hit.hp <= 0){
            score += 12;
            zombies.splice(zombies.indexOf(hit),1);
          }
        }
      }

      // zombies move + collision
      for(const z of zombies){
        const dx = player.x - z.x, dy = player.y - z.y;
        const l = Math.hypot(dx,dy) || 1;
        z.x += (dx/l) * z.spd * dt;
        z.y += (dy/l) * z.spd * dt;
        const d = Math.hypot(z.x-player.x, z.y-player.y);
        if(d < z.r + player.r){ endRun(false); return; }
      }

      // score from survival
      score += dt * 4;
      $("score").textContent = Math.floor(score);

      // rank (simple)
      const s = Math.floor(score);
      let rk="ROOKIE";
      if(s>250) rk="SCOUT";
      if(s>450) rk="HUNTER";
      if(s>700) rk="INFECTOR";
      if(s>1000) rk="OUTBREAK LORD";
      $("rank").textContent = rk;
    }

    function draw(){
      ctx.clearRect(0,0,cv.width,cv.height);

      // subtle grid
      ctx.globalAlpha = 0.12;
      ctx.strokeStyle = "#ffffff";
      for(let x=0;x<cv.width;x+=60){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,cv.height); ctx.stroke(); }
      for(let y=0;y<cv.height;y+=60){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(cv.width,y); ctx.stroke(); }
      ctx.globalAlpha = 1;

      // player
      ctx.fillStyle = "#45FF75";
      ctx.beginPath(); ctx.arc(player.x, player.y, player.r, 0, Math.PI*2); ctx.fill();

      // aura
      ctx.globalAlpha = 0.10;
      ctx.fillStyle = "#45FF75";
      ctx.beginPath(); ctx.arc(player.x, player.y, 95, 0, Math.PI*2); ctx.fill();
      ctx.globalAlpha = 1;

      // zombies
      ctx.fillStyle = "rgba(233,255,242,.85)";
      for(const z of zombies){
        ctx.globalAlpha = 0.85;
        ctx.beginPath(); ctx.arc(z.x, z.y, z.r, 0, Math.PI*2); ctx.fill();
      }
      ctx.globalAlpha = 1;
    }

    let last = 0;
    function loop(ts){
      if(!running) return;
      const dt = Math.min(0.033, (ts-last)/1000 || 0);
      last = ts;
      update(dt);
      draw();
      requestAnimationFrame(loop);
    }

    function startRun(){
      const s = init();
      if(!s.me){ toast("GET ID FIRST"); return; }
      resetRun();
      running = true;
      show("scrGame","RUN");
      last = performance.now();
      requestAnimationFrame(loop);
    }

    function endRun(survived){
      running = false;
      lastScore = Math.floor(score);
      const [m, tier] = mutationRoll();
      lastMut = `${m} (${tier})`;
      $("resScore").textContent = lastScore;
      $("resMut").textContent = lastMut;
      show("scrResult","RESULT");
    }

    $("btnPlay").onclick = startRun;
    $("btnReplay").onclick = startRun;
    $("btnQuit").onclick = ()=>{ running=false; show("scrLobby","LOBBY"); };

    // ===== UI render =====
    function render(){
      const s = init();
      const ref = getRef();
      $("refHint").textContent = "ref: " + (ref ? fmt(ref) : "‚Äî");

      const me = s.me;
      $("hudId").textContent = me ? fmt(me.id) : "‚Äî";
      $("pId").textContent = me ? fmt(me.id) : "‚Äî";
      $("pBy").textContent = me ? (me.by ? fmt(me.by) : "‚Äî") : "‚Äî";
      $("pInf").textContent = me ? String(me.inf||0) : "0";
      $("pCountry").textContent = me ? (me.country||"‚Äî") : "‚Äî";

      $("bigId").textContent = me ? fmt(me.id) : "#000000";
      $("meId").textContent = me ? fmt(me.id) : "‚Äî";
      $("meBy").textContent = me ? (me.by ? fmt(me.by) : "‚Äî") : "‚Äî";
      $("meInf").textContent = me ? String(me.inf||0) : "0";
      $("meCountry").textContent = me ? (me.country||"‚Äî") : "‚Äî";

      $("btnPlay").disabled = !me;
      $("btnCopy").disabled = !me;
      $("btnCard").disabled = !me;
    }

    // nav
    $("btnWorld").onclick = ()=> show("scrWorld","WORLD");
    $("btnIntro").onclick = ()=> show("scrIntro","STORY");

    // init
    $("btnPlay").disabled = true;
    applyI18n();
    render();

    // start screen
    show("scrIntro","STORY");
  </script>
</body>
</html>
