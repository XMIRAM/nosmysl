<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ЗомбиГлобал</title>

  <style>
    :root{
      --bg:#05070B;
      --panel:rgba(12,16,22,.72);
      --panel2:rgba(7,10,14,.78);
      --border:rgba(255,255,255,.12);
      --t1:#EAF7F1;
      --t2:rgba(234,247,241,.66);
      --g:#45FF75;
      --c:#2FA9FF;
      --r:#FF3D4D;
      --y:#FFD34A;
      --radius:20px;
      --shadow:0 24px 90px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--t1);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    #app{position:fixed;inset:0;overflow:hidden;background:radial-gradient(120% 90% at 50% 0%, rgba(47,169,255,.08), rgba(0,0,0,.88));}

    /* subtle grain + scan */
    #app::before{
      content:""; position:absolute; inset:-20px; pointer-events:none;
      background:repeating-linear-gradient(to bottom, rgba(255,255,255,.05) 0 1px, rgba(0,0,0,0) 1px 7px);
      opacity:.08; mix-blend-mode:overlay;
    }
    #app::after{
      content:""; position:absolute; inset:0; pointer-events:none;
      background-image:radial-gradient(rgba(255,255,255,.05) 1px, rgba(0,0,0,0) 1px);
      background-size: 3px 3px;
      opacity:.06; mix-blend-mode:overlay;
    }

    /* screens */
    .screen{position:absolute;inset:0;display:none}
    .screen.active{display:block}
    .fade{animation:fade .16s ease-out}
    @keyframes fade{from{opacity:.0;transform:scale(.996)}to{opacity:1;transform:scale(1)}}

    /* safe areas */
    @supports(padding:max(0px)){
      .safePad{
        padding:
          max(14px, env(safe-area-inset-top))
          max(14px, env(safe-area-inset-right))
          max(14px, env(safe-area-inset-bottom))
          max(14px, env(safe-area-inset-left));
      }
    }

    /* common UI */
    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .panel2{
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .muted{color:var(--t2);line-height:1.55}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:10px}

    .btn{
      all:unset;
      user-select:none; cursor:pointer;
      padding:14px 16px; border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--t1);
      letter-spacing:.10em; text-transform:uppercase; font-weight:950;
      text-align:center;
      backdrop-filter: blur(10px);
      transition:transform .08s ease, background .12s ease, border-color .12s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{background:rgba(69,255,117,.16);border-color:rgba(69,255,117,.28)}
    .btn.secondary{background:rgba(47,169,255,.12);border-color:rgba(47,169,255,.24)}
    .btn.danger{background:rgba(255,61,77,.12);border-color:rgba(255,61,77,.26)}
    .btn.gold{background:rgba(255,211,74,.12);border-color:rgba(255,211,74,.26)}

    .chip{
      display:inline-flex;align-items:center;gap:10px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.30);
      border-radius:999px;
      padding:10px 12px;
      backdrop-filter: blur(10px);
    }

    /* BOOT */
    #boot{display:flex;align-items:center;justify-content:center}
    .bootBox{width:min(520px,92vw);padding:18px}
    .logo{margin:0;letter-spacing:.18em;text-transform:uppercase;font-weight:950}
    .bar{height:10px;border-radius:999px;border:1px solid var(--border);overflow:hidden;background:rgba(255,255,255,.05);margin-top:12px}
    .fill{height:100%;width:0%;background:linear-gradient(90deg,var(--g),var(--c))}

    /* INTRO */
    #intro{position:absolute;inset:0}
    .introVideo{
      position:absolute; inset:0; width:100%; height:100%;
      object-fit:cover; background:#000;
      filter:saturate(1.05) contrast(1.05);
    }
    .introShade{
      position:absolute; inset:0;
      background:radial-gradient(120% 80% at 50% 10%, rgba(69,255,117,.18), rgba(0,0,0,.82));
      pointer-events:none;
    }
    .introHUD{
      position:absolute; inset:0;
      display:flex; align-items:flex-end; justify-content:center;
      pointer-events:none;
    }
    .introCard{
      width:min(640px,92vw);
      margin:14px;
      padding:14px;
      pointer-events:auto;
    }
    .introTop{
      display:flex;justify-content:space-between;align-items:flex-start;gap:10px
    }
    .introTitle{margin:0;letter-spacing:.16em;text-transform:uppercase;font-weight:950}
    .introSub{margin:10px 0 12px}
    .mini{font-size:12px;color:rgba(234,247,241,.58);line-height:1.5}
    .kbd{
      display:inline-block;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      font-weight:900;letter-spacing:.10em;text-transform:uppercase;
    }

    /* LOBBY (mobile-first) */
    #lobby{display:flex;align-items:stretch;justify-content:stretch}
    .lobbyBg{
      position:absolute; inset:0;
      background:
        radial-gradient(110% 80% at 50% 0%, rgba(47,169,255,.10), rgba(0,0,0,.92));
    }
    .lobbyWrap{
      position:absolute; inset:0;
      display:flex; flex-direction:column;
      gap:12px;
    }
    .topBar{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .brand{
      display:flex; flex-direction:column; gap:4px;
    }
    .brand h1{margin:0;font-size:16px;letter-spacing:.18em;text-transform:uppercase;font-weight:950}
    .brand div{font-size:11px;color:rgba(234,247,241,.56);letter-spacing:.10em;text-transform:uppercase}
    .card{
      padding:14px;
    }
    .grid2{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .idBig{font-size:30px;font-weight:950;letter-spacing:.08em;margin:6px 0 2px}
    .metaRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .field{
      width:100%;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.05);
      padding:12px 12px;
      color:rgba(234,247,241,.92);
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .actionsFixed{
      margin-top:auto;
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .actionsFixed .btn{padding:16px 16px;border-radius:18px;font-size:13px}

    /* drawer / modal */
    .modal{
      position:fixed; inset:0; display:none; align-items:flex-end; justify-content:center;
      background:rgba(0,0,0,.55);
      z-index:50;
    }
    .modal.active{display:flex}
    .sheet{
      width:min(720px,96vw);
      border-radius:22px 22px 0 0;
      padding:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(10,14,18,.88);
      backdrop-filter: blur(12px);
      box-shadow:0 -30px 90px rgba(0,0,0,.65);
      max-height:78vh;
      overflow:auto;
    }
    .sheetHead{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .sheetTitle{margin:0;letter-spacing:.14em;text-transform:uppercase;font-weight:950}
    .xBtn{
      all:unset; cursor:pointer;
      width:38px;height:38px;border-radius:14px;
      display:grid;place-items:center;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      font-weight:950;
    }

    /* RUN */
    #run{position:absolute;inset:0}
    .runBg{
      position:absolute; inset:0;
      background:radial-gradient(120% 90% at 50% 0%, rgba(69,255,117,.08), rgba(0,0,0,.92));
    }
    .hud{
      position:absolute; left:0; right:0; top:0;
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      padding:12px;
      z-index:5;
      pointer-events:none;
    }
    .hudBox{
      pointer-events:none;
      padding:10px 12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(10,14,18,.68);
      backdrop-filter: blur(10px);
      display:flex; gap:12px; align-items:center;
    }
    .hudLabel{font-size:11px;letter-spacing:.14em;text-transform:uppercase;color:rgba(234,247,241,.60);font-weight:950}
    .hudVal{font-size:18px;font-weight:950;letter-spacing:.06em}
    .panicBar{height:10px;border-radius:999px;border:1px solid rgba(255,255,255,.14);overflow:hidden;background:rgba(255,255,255,.05);margin-top:6px;width:160px}
    .panicFill{height:100%;width:0%;background:linear-gradient(90deg,var(--c),var(--r))}
    .canvasWrap{
      position:absolute; inset:0;
      padding:12px;
      z-index:2;
      touch-action:none;
    }
    canvas{
      width:100%; height:100%;
      border-radius:24px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.02);
    }
    .runBottom{
      position:absolute; left:0; right:0; bottom:0;
      padding:12px;
      display:flex; gap:10px; justify-content:space-between; align-items:center;
      z-index:6;
    }
    .tip{
      flex:1;
      font-size:11px;
      color:rgba(234,247,241,.68);
      letter-spacing:.10em;
      text-transform:uppercase;
      background:rgba(0,0,0,.36);
      border:1px solid rgba(255,255,255,.10);
      padding:10px 12px;
      border-radius:16px;
      backdrop-filter: blur(10px);
      overflow:hidden;
      white-space:nowrap;
      text-overflow:ellipsis;
    }
    .quitBtn{width:110px}

    /* RESULT */
    #result{position:absolute;inset:0}
    .resultBg{position:absolute;inset:0;background:radial-gradient(120% 90% at 50% 0%, rgba(47,169,255,.10), rgba(0,0,0,.92))}
    .resultWrap{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:14px;
      z-index:5;
    }
    .resultCard{width:min(720px,94vw);padding:14px}
    .stats{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .stat{padding:14px}
    .statName{font-size:11px;letter-spacing:.14em;text-transform:uppercase;color:rgba(234,247,241,.60);font-weight:950}
    .statVal{font-size:30px;font-weight:950;letter-spacing:.06em;margin-top:6px}
    .resultActions{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
    .resultActions .btn{padding:16px;border-radius:18px}

    /* better on wide screens */
    @media (min-width: 900px){
      .grid2{grid-template-columns:1fr 1fr}
      .actionsFixed{grid-template-columns:1fr 1fr}
      .resultActions{grid-template-columns:1fr 1fr}
    }
  </style>
</head>

<body>
<div id="app">

  <!-- BOOT -->
  <div class="screen active" id="boot">
    <div class="panel bootBox">
      <h1 class="logo">ЗомбиГлобал</h1>
      <div class="muted" style="margin-top:8px">Загрузка протокола заражения…</div>
      <div class="bar"><div class="fill" id="bootFill"></div></div>
      <div class="mini" style="margin-top:10px">mobile-first • портрет норм • звук после тапа</div>
    </div>
  </div>

  <!-- INTRO -->
  <div class="screen" id="intro">
    <video class="introVideo" id="introVideo" playsinline muted autoplay></video>
    <div class="introShade"></div>

    <div class="introHUD safePad">
      <div class="panel introCard">
        <div class="introTop">
          <div>
            <div class="kbd">THE VIRUS IS THE LINK</div>
            <h2 class="introTitle" style="margin-top:10px">Вирус — это ссылка.</h2>
          </div>
          <button class="btn" id="skipIntro" style="padding:10px 12px;border-radius:14px">SKIP</button>
        </div>

        <p class="introSub muted">
          Получи свой номер заражения. Распространяй ссылку. Жми рекорд — чтобы люди репостили твой «след».
        </p>

        <div class="col">
          <button class="btn primary" id="tapStart">TAP TO START (SOUND ON)</button>
          <div class="mini">На iPhone звук включается только после первого тапа (правило браузера).</div>
        </div>
      </div>
    </div>
  </div>

  <!-- LOBBY -->
  <div class="screen" id="lobby">
    <div class="lobbyBg"></div>

    <div class="lobbyWrap safePad">
      <div class="topBar">
        <div class="brand">
          <h1>ЗомбиГлобал</h1>
          <div>Кто заразит мир быстрее всех — тот легенда</div>
        </div>
        <div class="chip">
          <span style="letter-spacing:.14em;text-transform:uppercase;font-weight:950;color:rgba(234,247,241,.60)">Season</span>
          <span class="mono" id="uiSeason">Month</span>
        </div>
      </div>

      <div class="grid2">
        <div class="panel card">
          <div class="hudLabel">ТВОЙ НОМЕР</div>
          <div class="idBig mono" id="uiId">#------</div>
          <div class="metaRow">
            <span class="chip mono" id="uiCountry">--</span>
            <span class="chip" id="uiBy">Заражен от: #------</span>
          </div>

          <div class="muted" style="margin-top:12px">Твоя вирус-ссылка:</div>
          <div class="field mono" id="uiLink">—</div>

          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="copyLink">COPY LINK</button>
            <button class="btn secondary" id="openInfect">ИНФО / ИНФЕКТ</button>
          </div>
        </div>

        <div class="panel card">
          <div class="hudLabel">БЫСТРАЯ ИГРА</div>
          <div style="font-weight:950;font-size:18px;letter-spacing:.08em;text-transform:uppercase;margin-top:8px">
            Containment Run
          </div>
          <p class="muted" style="margin:10px 0 0">
            35 секунд. Управление пальцем. Собирай <span style="color:var(--g);font-weight:950">GREEN</span>,
            избегай <span style="color:var(--r);font-weight:950">RED</span>. Комбо = больше очков.
          </p>

          <div class="row" style="margin-top:12px">
            <button class="btn primary" id="play">PLAY</button>
            <button class="btn gold" id="leaderboard">LEADERBOARD</button>
          </div>

          <div class="row" style="margin-top:10px">
            <button class="btn secondary" id="tgChannel">TG CHANNEL</button>
            <button class="btn secondary" id="tgBot">TG BOT</button>
          </div>

          <div class="mini" style="margin-top:10px">
            Цель: рекорд → скачай share-card → репост → новые заражения по твоей ссылке.
          </div>
        </div>
      </div>

      <div class="actionsFixed">
        <button class="btn primary" id="play2">PLAY RUN</button>
        <button class="btn secondary" id="copy2">COPY INFECT LINK</button>
      </div>
    </div>
  </div>

  <!-- MODAL (bottom sheet) -->
  <div class="modal" id="modal">
    <div class="sheet">
      <div class="sheetHead">
        <h3 class="sheetTitle" id="modalTitle">TITLE</h3>
        <button class="xBtn" id="modalClose">✕</button>
      </div>
      <div id="modalBody" style="margin-top:10px"></div>
    </div>
  </div>

  <!-- RUN -->
  <div class="screen" id="run">
    <div class="runBg"></div>

    <div class="hud safePad">
      <div class="hudBox">
        <div>
          <div class="hudLabel">TIME</div>
          <div class="hudVal mono" id="hudTime">00:35</div>
        </div>
        <div>
          <div class="hudLabel">SCORE</div>
          <div class="hudVal mono" id="hudScore">0</div>
        </div>
        <div>
          <div class="hudLabel">COMBO</div>
          <div class="hudVal mono" id="hudCombo">0x</div>
        </div>
      </div>

      <div class="hudBox">
        <div>
          <div class="hudLabel">PANIC</div>
          <div class="panicBar"><div class="panicFill" id="panicFill"></div></div>
        </div>
      </div>
    </div>

    <div class="canvasWrap safePad" id="canvasWrap">
      <canvas id="gameCanvas"></canvas>
    </div>

    <div class="runBottom safePad">
      <div class="tip">Drag finger to move • GREEN + score • RED + panic</div>
      <button class="btn danger quitBtn" id="quit">QUIT</button>
    </div>
  </div>

  <!-- RESULT -->
  <div class="screen" id="result">
    <div class="resultBg"></div>

    <div class="resultWrap safePad">
      <div class="panel resultCard">
        <div class="stats">
          <div class="panel2 stat">
            <div class="statName">RUN SCORE</div>
            <div class="statVal mono" id="resScore">0</div>
          </div>
          <div class="panel2 stat">
            <div class="statName">BEST</div>
            <div class="statVal mono" id="resBest">0</div>
          </div>
        </div>

        <div class="muted" style="margin:12px 0 6px">Твоя вирус-ссылка:</div>
        <div class="field mono" id="resLink">—</div>

        <div class="resultActions">
          <button class="btn primary" id="copyRes">COPY LINK</button>
          <button class="btn secondary" id="downloadCard">DOWNLOAD SHARE CARD</button>
          <button class="btn primary" id="retry">RETRY</button>
          <button class="btn secondary" id="back">BACK</button>
        </div>

        <div class="mini" style="margin-top:10px">
          Share-card — это топовый крючок для вирусности. Люди репостят картинку → заходят по твоей ссылке.
        </div>
      </div>
    </div>

    <canvas id="shareCanvas" width="1080" height="1350" style="display:none"></canvas>
  </div>

</div>

<script>
/* ---------- ROUTER ---------- */
const screens = {
  boot:   document.getElementById('boot'),
  intro:  document.getElementById('intro'),
  lobby:  document.getElementById('lobby'),
  run:    document.getElementById('run'),
  result: document.getElementById('result'),
};
function show(name){
  Object.values(screens).forEach(s=>{ s.classList.remove('active','fade'); });
  screens[name].classList.add('active','fade');
}

/* ---------- LINKS (твои) ---------- */
const TG_CHANNEL = "https://t.me/zombievirus_server";
const TG_BOT     = "https://t.me/ZombieVirusLabBot";

/* ---------- HELPERS ---------- */
function pad6(n){ return String(n).padStart(6,'0'); }
function baseUrl(){ return window.location.href.split('#')[0].split('?')[0]; }
function params(){
  const u=new URL(window.location.href);
  return { ref:u.searchParams.get('ref'), creator:u.searchParams.get('creator') };
}
async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
    return true;
  }catch(e){
    try{ window.prompt("Copy this:", text); }catch(_){}
    return false;
  }
}

/* ---------- ID / REF ---------- */
const LS_ID='zg_id', LS_BEST='zg_best', LS_BY='zg_by', LS_CREATOR='zg_creator', LS_COUNTRY='zg_country';

function country(){
  let c=localStorage.getItem(LS_COUNTRY);
  if(!c){ c='AT'; localStorage.setItem(LS_COUNTRY,c); }
  return c;
}
function getOrCreateId(){
  const p=params();
  if (p.creator==='1') localStorage.setItem(LS_CREATOR,'1');
  if (localStorage.getItem(LS_CREATOR)==='1'){
    localStorage.setItem(LS_ID,'000001');
    return '000001';
  }
  let id=localStorage.getItem(LS_ID);
  if(!id){
    id=pad6(Math.floor(100000 + Math.random()*900000));
    localStorage.setItem(LS_ID,id);
  }
  return id;
}
function initRef(){
  const p=params();
  if (p.ref && /^\d{6}$/.test(p.ref)){
    const my=getOrCreateId();
    if (p.ref !== my) localStorage.setItem(LS_BY, p.ref);
  }
}
function infectLink(id){ return `${baseUrl()}?ref=${id}`; }

function updateLobbyUI(){
  const id=getOrCreateId();
  const by=localStorage.getItem(LS_BY) || '------';
  document.getElementById('uiId').textContent = `#${id}`;
  document.getElementById('uiCountry').textContent = country();
  document.getElementById('uiBy').textContent = `Заражен от: #${by}`;
  document.getElementById('uiSeason').textContent = `Month #${new Date().getMonth()+1}`;
  document.getElementById('uiLink').textContent = infectLink(id);
}

/* ---------- BOOT ---------- */
const bootFill=document.getElementById('bootFill');
let bp=0;
const bt=setInterval(()=>{
  bp+=10; bootFill.style.width=Math.min(bp,100)+'%';
  if(bp>=100){ clearInterval(bt); startIntro(); }
}, 55);

/* ---------- INTRO (video + sound unlock) ---------- */
const introVideo=document.getElementById('introVideo');
const tapStart=document.getElementById('tapStart');
const skipIntro=document.getElementById('skipIntro');

function startIntro(){
  initRef();
  updateLobbyUI();
  show('intro');

  introVideo.src = "assets/video/intro.mp4";

  // autoplay muted (allowed)
  try{ introVideo.play(); }catch(e){}
}

async function startWithSound(){
  // iPhone: audio only after gesture
  try{
    introVideo.muted = false;
    introVideo.volume = 1;
    await introVideo.play();
  }catch(e){
    // если вдруг видео не загрузилось/заблокировалось — не мешаем входу
  }
  show('lobby'); updateLobbyUI();
}

tapStart.addEventListener('click', startWithSound);
skipIntro.addEventListener('click', ()=>{ show('lobby'); updateLobbyUI(); });

/* ---------- MODAL ---------- */
const modal=document.getElementById('modal');
const modalTitle=document.getElementById('modalTitle');
const modalBody=document.getElementById('modalBody');
document.getElementById('modalClose').onclick=()=> modal.classList.remove('active');
function openModal(title, html){
  modalTitle.textContent=title;
  modalBody.innerHTML=html;
  modal.classList.add('active');
}

/* ---------- LOBBY actions ---------- */
document.getElementById('copyLink').onclick = async ()=>{
  const ok = await copyText(infectLink(getOrCreateId()));
  if(!ok) return;
};
document.getElementById('copy2').onclick = async ()=> {
  await copyText(infectLink(getOrCreateId()));
};

document.getElementById('openInfect').onclick = ()=>{
  const id=getOrCreateId();
  openModal("INFECT", `
    <div class="muted">Твоя вирус-ссылка (копируй и кидай людям):</div>
    <div class="field mono" style="margin-top:10px">${infectLink(id)}</div>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="mCopy">COPY</button>
      <button class="btn secondary" id="mTg">TG CHANNEL</button>
    </div>
    <div class="mini" style="margin-top:10px">
      Вирусность = люди видят твою share-card картинку, хотят перебить твой рекорд и тоже заражают.
    </div>
  `);
  document.getElementById('mCopy').onclick=()=>copyText(infectLink(id));
  document.getElementById('mTg').onclick=()=>window.open(TG_CHANNEL, "_blank");
};

document.getElementById('leaderboard').onclick = ()=>{
  openModal("LEADERBOARD (prototype)", `
    <div class="muted">Пока это прототип. Реальный топ будет после бэкенда.</div>
    <div class="field mono" style="margin-top:10px">#1  INFECTED #000120 — 184</div>
    <div class="field mono" style="margin-top:8px">#2  INFECTED #000381 — 152</div>
    <div class="field mono" style="margin-top:8px">#3  INFECTED #000905 — 99</div>
    <div class="mini" style="margin-top:10px">Каждый месяц: reset + турниры + призы (как ты планировал).</div>
  `);
};

document.getElementById('tgChannel').onclick = ()=> window.open(TG_CHANNEL, "_blank");
document.getElementById('tgBot').onclick     = ()=> window.open(TG_BOT, "_blank");

/* ---------- GAME (touch-friendly) ---------- */
const canvasWrap=document.getElementById('canvasWrap');
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');

const hudTime=document.getElementById('hudTime');
const hudScore=document.getElementById('hudScore');
const hudCombo=document.getElementById('hudCombo');
const panicFill=document.getElementById('panicFill');

let running=false, raf=0, last=0;
let timeLeft=35, score=0, combo=0, panic=0.12;
let player={x:0,y:0,tx:0,ty:0,r:22};
let ents=[], sparks=[];
let spawnT=0;

function resizeCanvas(){
  const rect=canvasWrap.getBoundingClientRect();
  const dpr=Math.min(2, window.devicePixelRatio||1);
  canvas.width=Math.floor(rect.width*dpr);
  canvas.height=Math.floor(rect.height*dpr);
  canvas.style.width=rect.width+"px";
  canvas.style.height=rect.height+"px";
  ctx.setTransform(dpr,0,0,dpr,0,0);

  // place player near bottom center
  player.x = rect.width*0.5;
  player.y = rect.height*0.78;
  player.tx = player.x;
  player.ty = player.y;
}

function pad2(n){return String(n).padStart(2,'0');}
function updateTimeUI(){
  const t=Math.max(0, Math.ceil(timeLeft));
  hudTime.textContent=`00:${pad2(t)}`;
}
function rand(a,b){return a+Math.random()*(b-a);}

function resetRun(){
  timeLeft=35; score=0; combo=0; panic=0.12; spawnT=0;
  ents=[]; sparks=[];
  hudScore.textContent='0';
  hudCombo.textContent='0x';
  panicFill.style.width='0%';
  updateTimeUI();
  resizeCanvas();
}

function spawnEnt(){
  const rect=canvasWrap.getBoundingClientRect();
  const w=rect.width, h=rect.height;
  const bad = Math.random() < 0.28 + (1-timeLeft/35)*0.10;
  const r = bad ? rand(12,18) : rand(12,20);

  // spawn from top with mild drift (mobile-friendly)
  const x=rand(r, w-r);
  const y=-r-10;
  const vy=rand(140, 240) + (1-timeLeft/35)*160;
  const vx=rand(-60,60);
  ents.push({x,y,vx,vy,r,bad});
}

function sparkBurst(x,y,color){
  for(let i=0;i<14;i++){
    const a=Math.random()*Math.PI*2;
    const sp=rand(80,260);
    sparks.push({x,y,vx:Math.cos(a)*sp,vy:Math.sin(a)*sp,life:rand(.14,.32),c:color});
  }
}

function startRun(){
  show('run');
  resetRun();
  running=true;
  last=performance.now();
  raf=requestAnimationFrame(loop);
}

function endRun(){
  running=false;
  cancelAnimationFrame(raf);

  const best=parseInt(localStorage.getItem(LS_BEST)||'0',10);
  const newBest=Math.max(best, score);
  localStorage.setItem(LS_BEST, String(newBest));

  const id=getOrCreateId();
  document.getElementById('resScore').textContent=String(score);
  document.getElementById('resBest').textContent=String(newBest);
  document.getElementById('resLink').textContent=infectLink(id);

  generateShareCard({id, score, best:newBest, country:country()});
  show('result');
}

function loop(now){
  const dt=Math.min(0.033, (now-last)/1000);
  last=now;

  timeLeft -= dt;
  spawnT += dt;

  // panic slowly rises -> pressure
  panic = Math.min(1, panic + dt*0.008);

  // player smoothing to target (finger)
  player.x += (player.tx - player.x) * Math.min(1, dt*12);
  player.y += (player.ty - player.y) * Math.min(1, dt*12);

  // spawn rate grows
  const interval = 0.32 - (1-timeLeft/35)*0.10;
  while(spawnT >= interval){ spawnT -= interval; spawnEnt(); }

  const rect=canvasWrap.getBoundingClientRect();
  const w=rect.width, h=rect.height;

  // move ents
  for(const e of ents){
    e.x += e.vx*dt;
    e.y += e.vy*dt;
  }
  ents = ents.filter(e=> e.y < h+80);

  // sparks
  for(const s of sparks){
    s.x += s.vx*dt; s.y += s.vy*dt; s.life -= dt;
    s.vx *= (1 - dt*10); s.vy *= (1 - dt*10);
  }
  sparks = sparks.filter(s=> s.life>0);

  // collisions
  for(let i=ents.length-1;i>=0;i--){
    const e=ents[i];
    const dx=e.x-player.x, dy=e.y-player.y;
    const rr=e.r+player.r;
    if(dx*dx+dy*dy <= rr*rr){
      if(e.bad){
        panic = Math.min(1, panic + 0.24);
        combo = 0;
        sparkBurst(e.x,e.y,'rgba(255,61,77,1)');
      }else{
        combo = Math.min(99, combo+1);
        const mult = 1 + Math.min(2.6, combo*0.06);
        score += Math.floor(10*mult);
        panic = Math.max(0, panic - 0.16);
        sparkBurst(e.x,e.y,'rgba(69,255,117,1)');
      }
      ents.splice(i,1);
    }
  }

  // UI
  hudScore.textContent=String(score);
  hudCombo.textContent=`${combo}x`;
  panicFill.style.width=`${Math.floor(panic*100)}%`;
  updateTimeUI();

  render(w,h);

  if(timeLeft<=0 || panic>=1){
    endRun();
    return;
  }
  raf=requestAnimationFrame(loop);
}

function render(w,h){
  ctx.clearRect(0,0,w,h);

  // soft glow
  const g=ctx.createRadialGradient(w*.5,h*.2,80,w*.5,h*.5,Math.max(w,h)*.75);
  g.addColorStop(0,'rgba(47,169,255,0.10)');
  g.addColorStop(1,'rgba(0,0,0,0.74)');
  ctx.fillStyle=g; ctx.fillRect(0,0,w,h);

  // lane hint (subtle)
  ctx.strokeStyle='rgba(255,255,255,0.06)';
  ctx.lineWidth=1;
  ctx.beginPath();
  ctx.moveTo(w*0.33, 0); ctx.lineTo(w*0.33, h);
  ctx.moveTo(w*0.66, 0); ctx.lineTo(w*0.66, h);
  ctx.stroke();

  // ents
  for(const e of ents){
    ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,Math.PI*2);
    ctx.fillStyle = e.bad ? 'rgba(255,61,77,0.14)' : 'rgba(69,255,117,0.14)';
    ctx.fill();
    ctx.strokeStyle = e.bad ? 'rgba(255,61,77,0.62)' : 'rgba(69,255,117,0.62)';
    ctx.lineWidth=2;
    ctx.stroke();
  }

  // sparks
  for(const s of sparks){
    ctx.globalAlpha = Math.max(0, s.life*3.0);
    ctx.fillStyle = s.c;
    ctx.fillRect(s.x-1.5, s.y-1.5, 3, 3);
    ctx.globalAlpha = 1;
  }

  // player
  ctx.beginPath(); ctx.arc(player.x,player.y,player.r,0,Math.PI*2);
  ctx.fillStyle='rgba(234,247,241,0.10)'; ctx.fill();
  ctx.strokeStyle='rgba(234,247,241,0.34)'; ctx.lineWidth=2; ctx.stroke();

  // crosshair
  ctx.strokeStyle='rgba(234,247,241,0.16)';
  ctx.beginPath();
  ctx.moveTo(player.x-26, player.y); ctx.lineTo(player.x+26, player.y);
  ctx.moveTo(player.x, player.y-26); ctx.lineTo(player.x, player.y+26);
  ctx.stroke();
}

function setTarget(clientX, clientY){
  const rect=canvasWrap.getBoundingClientRect();
  const x=Math.max(player.r, Math.min(rect.width-player.r, clientX-rect.left));
  const y=Math.max(player.r, Math.min(rect.height-player.r, clientY-rect.top));
  player.tx=x; player.ty=y;
}

canvasWrap.addEventListener('pointerdown', (e)=>{
  e.preventDefault();
  setTarget(e.clientX, e.clientY);
});
canvasWrap.addEventListener('pointermove', (e)=>{
  if(e.buttons===0 && e.pointerType==="mouse") return;
  setTarget(e.clientX, e.clientY);
});
canvasWrap.addEventListener('touchstart', (e)=>{
  e.preventDefault();
  const t=e.touches[0]; setTarget(t.clientX, t.clientY);
},{passive:false});
canvasWrap.addEventListener('touchmove', (e)=>{
  e.preventDefault();
  const t=e.touches[0]; setTarget(t.clientX, t.clientY);
},{passive:false});

window.addEventListener('resize', ()=>{
  if(screens.run.classList.contains('active')) resizeCanvas();
});

/* lobby buttons -> run */
document.getElementById('play').onclick = startRun;
document.getElementById('play2').onclick = startRun;
document.getElementById('quit').onclick = ()=>{ running=false; cancelAnimationFrame(raf); show('lobby'); };

/* ---------- RESULT actions ---------- */
document.getElementById('retry').onclick = startRun;
document.getElementById('back').onclick  = ()=>{ show('lobby'); updateLobbyUI(); };

document.getElementById('copyRes').onclick = async ()=>{
  await copyText(infectLink(getOrCreateId()));
};

document.getElementById('downloadCard').onclick = ()=> downloadShareCard();

/* ---------- SHARE CARD ---------- */
const shareCanvas=document.getElementById('shareCanvas');
const sctx=shareCanvas.getContext('2d');

function generateShareCard(data){
  const {id, score, best, country} = data;
  const W=shareCanvas.width, H=shareCanvas.height;

  // bg
  const g=sctx.createLinearGradient(0,0,W,H);
  g.addColorStop(0,'#070B12');
  g.addColorStop(1,'#04050A');
  sctx.fillStyle=g; sctx.fillRect(0,0,W,H);

  // glow
  const rg=sctx.createRadialGradient(W*0.45,H*0.18,50,W*0.50,H*0.25,760);
  rg.addColorStop(0,'rgba(69,255,117,0.18)');
  rg.addColorStop(1,'rgba(0,0,0,0)');
  sctx.fillStyle=rg; sctx.fillRect(0,0,W,H);

  // title
  sctx.fillStyle='rgba(234,247,241,0.92)';
  sctx.font='900 64px system-ui, -apple-system, Segoe UI, Roboto, Arial';
  sctx.fillText('ZOMBIEGLOBAL', 70, 130);

  sctx.fillStyle='rgba(234,247,241,0.70)';
  sctx.font='900 28px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace';
  sctx.fillText(`INFECTED #${id}  •  ${country}`, 70, 190);

  // score
  sctx.fillStyle='rgba(69,255,117,0.92)';
  sctx.font='950 140px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace';
  sctx.fillText(String(score), 70, 390);

  sctx.fillStyle='rgba(234,247,241,0.72)';
  sctx.font='900 28px system-ui, -apple-system, Segoe UI, Roboto, Arial';
  sctx.fillText('RUN SCORE', 70, 440);

  sctx.fillStyle='rgba(47,169,255,0.92)';
  sctx.font='900 40px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace';
  sctx.fillText(`BEST: ${best}`, 70, 520);

  // link
  const link=infectLink(id);
  sctx.fillStyle='rgba(234,247,241,0.60)';
  sctx.font='900 26px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace';
  wrapText(sctx, link, 70, 1180, 940, 32);

  sctx.fillStyle='rgba(234,247,241,0.58)';
  sctx.font='900 22px system-ui, -apple-system, Segoe UI, Roboto, Arial';
  sctx.fillText('THE VIRUS IS THE LINK. SHARE IT.', 70, 1260);
}

function wrapText(ctx, text, x, y, maxWidth, lineHeight){
  const words = text.split(' ');
  let line = '';
  for (let n=0;n<words.length;n++){
    const testLine = line + words[n] + ' ';
    if (ctx.measureText(testLine).width > maxWidth && n>0){
      ctx.fillText(line, x, y);
      line = words[n] + ' ';
      y += lineHeight;
    } else {
      line = testLine;
    }
  }
  ctx.fillText(line, x, y);
}

function downloadShareCard(){
  const url=shareCanvas.toDataURL('image/png');
  const a=document.createElement('a');
  a.href=url;
  a.download=`zombieglobal_${getOrCreateId()}_score.png`;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* ---------- Init ---------- */
initRef();
updateLobbyUI();
</script>
</body>
</html>
